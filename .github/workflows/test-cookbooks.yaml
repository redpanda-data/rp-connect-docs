name: Test Cookbook Examples

on:
  pull_request:
    branches: [main]
    paths:
      - 'modules/cookbooks/examples/**/*.yaml'
      - 'modules/cookbooks/examples/**/*.sh'
      - '.github/workflows/test-cookbooks.yaml'
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      category:
        description: 'Category to test (leave empty for all)'
        required: false
        type: string
      run_integration:
        description: 'Run integration tests'
        required: false
        type: boolean
        default: true
  # Triggered by RPCN release workflow
  repository_dispatch:
    types: [test-cookbook-examples]

permissions:
  id-token: write
  contents: read
  issues: write

jobs:
  # Quick unit tests for all examples
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm install

      - name: Install tools
        run: |
          npx doc-tools install-test-dependencies
          rpk connect install

      - name: Run unit tests
        run: |
          cd modules/cookbooks/examples
          chmod +x test-examples.sh
          ./test-examples.sh --unit-only

  # Integration tests with Docker Compose (run in parallel by category)
  integration-tests:
    name: Integration Tests - ${{ matrix.category }}
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.run_integration == 'true' ||
      github.event_name == 'repository_dispatch' ||
      github.event_name == 'push' ||
      github.event_name == 'pull_request'
    needs: unit-tests  # Only run if unit tests pass
    strategy:
      matrix:
        category: [dynamodb_cdc]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm install

      - name: Install tools
        run: |
          npx doc-tools install-test-dependencies
          rpk connect install

      - name: Install AWS CLI
        run: |
          # AWS CLI is pre-installed on GitHub runners, but ensure it's available
          aws --version || pip install awscli

      - name: Test ${{ matrix.category }} examples
        run: |
          cd modules/cookbooks/examples

          # Skip if category doesn't exist
          if [[ ! -d "${{ matrix.category }}" ]]; then
            echo "Category ${{ matrix.category }} not found, skipping"
            exit 0
          fi

          # Skip if no docker-compose.yaml
          if [[ ! -f "${{ matrix.category }}/docker-compose.yaml" ]]; then
            echo "No docker-compose.yaml in ${{ matrix.category }}, running unit tests only"
            chmod +x test-examples.sh
            ./test-examples.sh --unit-only "${{ matrix.category }}"
            exit 0
          fi

          echo "ðŸ³ Starting Docker services for ${{ matrix.category }}..."
          cd "${{ matrix.category }}"
          docker compose up -d --wait

          echo "ðŸ“Š Docker service status:"
          docker compose ps

          # Run setup script if it exists
          if [[ -x "setup-test-data.sh" ]]; then
            echo "ðŸ”§ Running setup script..."
            ./setup-test-data.sh
          fi

          # Run integration tests
          echo "ðŸ§ª Running integration tests..."
          cd ..
          chmod +x test-examples.sh
          ./test-examples.sh --integration-only "${{ matrix.category }}"

      - name: Cleanup Docker
        if: always()
        run: |
          cd modules/cookbooks/examples/${{ matrix.category }}
          docker compose down -v 2>/dev/null || true

      - name: Show Docker logs on failure
        if: failure()
        run: |
          cd modules/cookbooks/examples/${{ matrix.category }}
          echo "=== Docker Compose logs ==="
          docker compose logs 2>/dev/null || true

  # Summary job that depends on all tests
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: always()

    steps:
      - name: Check test results
        id: check
        run: |
          if [[ "${{ needs.unit-tests.result }}" == "failure" ]]; then
            echo "âŒ Unit tests failed"
            echo "failed=true" >> "$GITHUB_OUTPUT"
            echo "failure_reason=Unit tests failed" >> "$GITHUB_OUTPUT"
          elif [[ "${{ needs.integration-tests.result }}" == "failure" ]]; then
            echo "âŒ Integration tests failed"
            echo "failed=true" >> "$GITHUB_OUTPUT"
            echo "failure_reason=Integration tests failed" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… All tests passed!"
            echo "failed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create failure issue
        if: steps.check.outputs.failed == 'true' && github.event_name == 'repository_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const failureReason = '${{ steps.check.outputs.failure_reason }}';
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            // Check for existing open issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'cookbook-test-failure',
              per_page: 1
            });

            const body = `## Cookbook Tests Failed

            **Reason:** ${failureReason}

            This failure was triggered by a Redpanda Connect release. The cookbook examples may need updates to work with the new version.

            **Workflow run:** ${runUrl}

            ### Next steps
            1. Check the workflow logs for details
            2. Run the tests locally: \`cd modules/cookbooks/examples && ./test-examples.sh\`
            3. Fix any broken examples
            4. Close this issue when resolved`;

            if (existingIssues.data.length > 0) {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: `## Tests failed again\n\n${body}`
              });
              console.log(`Updated existing issue #${existingIssues.data[0].number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Cookbook tests failed after RPCN release`,
                body: body,
                labels: ['cookbook-test-failure', 'bug']
              });
              console.log(`Created issue #${issue.data.number}`);
            }

      - name: Fail if tests failed
        if: steps.check.outputs.failed == 'true'
        run: exit 1
