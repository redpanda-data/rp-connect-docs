= Use MCP Server with Claude CLI

This guide shows you how to expose internal tools using Redpanda Connect's *MCP server*, and how to interact with them using *Claude CLI*.

Claude will automatically discover and use your tools via natural language—no custom prompts or glue code required.

== Why use MCP with Claude?

The MCP server makes your local tools *AI-consumable*. It exposes them with metadata that Claude can understand and use to:

- Discover available tools
- Understand required inputs and output format
- Make intelligent, structured HTTP requests

This enables natural-language automation for internal workflows, using your own business logic.

== Prerequisites

You'll need:

- Redpanda CLI (`rpk`) installed
- Claude CLI installed and configured
- A YAML-based tool definition
- An internet connection (for tools that call public APIs)

```
rpk connect mcp-server init
```

This command creates the folder structure for your MCP server, including a `tools` directory where you can define your tools.

TODO: Ask ash why the folder is called resources when we create tools.

== Step 1: Create a Tool Definition

Save the following to a file named `tools/bluesky.yaml`.

This tool enables Claude to search public Bluesky posts using natural language.

[source,yaml]
----
label: search-bluesky-posts
try:
  - mutation: |
      root.limit = root.limit.number(25)
      root.limit = [ root.limit, 100 ].min()
      root.limit = [ root.limit, 1 ].max()
      meta query_string = "q=" + root.query.escape_url_query() + "&limit=%v".format(root.limit)
      root = ""
  - http:
      url: "https://public.api.bsky.app/xrpc/app.bsky.feed.searchPosts?${! @query_string }"
      verb: GET
  - mapping: 'root = this.posts'
  - unarchive:
      format: json_array

meta:
  tags: [ demo ]
  mcp:
    enabled: true
    description: Search public Bluesky posts based on a query string.
  properties:
    - name: query
      type: string
      required: true
      description: A Lucene-style query string to search posts.
    - name: limit
      type: number
      description: Number of posts to return (1–100). Defaults to 25.
----

== Step 2: Start the MCP Server

Start the server and expose the tool via HTTP:

[source,bash]
----
rpk connect mcp-server --address localhost:4195 --tag demo
----

This launches an MCP server listening on `localhost:4195`, and makes your tool discoverable to AI agents.

:tip-caption: Limit exposure

[TIP]
====
Only tools with the specified `--tag` are exposed. This helps you:

- Keep experiments isolated
- Avoid exposing sensitive functionality accidentally
- Create sets of tools that are relevant to specific agents or workflows
====

== step 3 Connect a local event source to the MCP Server

To make a live event stream from your local service available to the Claude MCP server for Redpanda Connect workflows, use the following command:

[,bash]
----
claude mcp add local -- npx mcp-remote http://localhost:4195/sse
----

1. `claude mcp add local --`
+
This tells Claude to set up a new *local input channel*—a subprocess or pipe that streams messages. The `--` delimiter ensures that everything after it is treated as a shell command to execute.

2. `npx mcp-remote http://localhost:4195/sse`
+
This runs the `mcp-remote` utility, which:
+
- Connects to the provided SSE endpoint
- Converts events into MCP message format
- Writes them to stdout
+
Claude reads these messages from the subprocess, treating them as if they were emitted by a native MCP agent.

Claude will automatically read the tool definitions, including:

- The label and description
- The expected parameters
- How to call each tool

Even if your service is already running an MCP server to expose tools, that only covers **on-demand tool execution** (Claude calling your logic via HTTP).

The `claude mcp add local` command sets up a **streaming input** that allows *your service to push events into Claude in real time*.

This is essential for event-driven workflows where Claude needs to:

- React to incoming messages or sensor data
- Maintain live context in multi-agent systems
- Handle asynchronous updates as they occur

`mcp-remote` is a lightweight bridge that turns any streaming HTTP endpoint into a source of **MCP-compatible messages**.

In this case:

- Your service exposes a Server-Sent Events (SSE) stream at `http://localhost:4195/sse`
- `mcp-remote` connects to that stream and reads the events
- It converts each event into a structured MCP message
- Those messages are forwarded to Claude via the local input channel created by `claude mcp add local`

This allows Claude to receive a continuous stream of updates from your system, just like it would from a WebSocket, Kafka topic, or sensor feed.

== Step 4: Try a Natural Language Query

Run Claude in a terminal:
[source,bash]
----
claude
----

When Claude is running, just ask:

> Find recent posts on Bluesky mentioning Redpanda.

Claude will:

1. Discover the `search-bluesky-posts` tool
2. Fill in the `query` property
3. Send an HTTP request to your local MCP server
4. Return the result in conversation

if you change a component, make sure to restart the MCP server to pick up the changes.

Required to use [INST] to make sure the LLM recognizes the query as an instruction not a query or a statement.

== Next steps

Tools exposed by MCP are self-describing and schema-rich. This makes them ideal for use with Claude, LangChain, AutoGPT, and other agent frameworks—without needing any adapters, OpenAPI specs, or plugins.

- Add more tools under the same tag to expand Claude's capabilities
- Use internal tools, scripts, or APIs to automate workflows
- Share your MCP server on your LAN or VPN for team use


