// Shared content for production workflows - part 1 (before secrets section)
// Used by both self-managed Redpanda Connect and Remote MCP servers in Cloud
// Source: rp-connect-docs/modules/ai-agents/pages/mcp-server/pipeline-patterns.adoc
//
// Include syntax:
// - From rp-connect-docs: include::ai-agents:partial$mcp/production-workflows-before-secrets.adoc[]
// - From cloud-docs: include::redpanda-connect:ai-agents:partial$mcp/production-workflows-before-secrets.adoc[]

== Production workflows and observability

Build enterprise-grade tools with error handling, validation, multi-step workflows, and monitoring.

=== Parameter validation and type coercion

Always validate and coerce input parameters to ensure your tools are robust:

[source,yaml]
----
processors:
  - label: validate_params
    mutation: |
      # Validate required parameters
      root = if !this.exists("user_id") {
        throw("user_id parameter is required")
      } else { this }

      # Type coercion with validation
      meta user_id = this.user_id.string()
      meta limit = this.limit.number().catch(10)
      meta start_date = this.start_date.parse_timestamp("2006-01-02").catch(now() - duration("24h"))
----

=== Dynamic configuration

Build tools that adapt their behavior based on input parameters:

[source,yaml]
----
processors:
  - label: dynamic_config
    mutation: |
      # Choose data source based on environment
      meta env = this.environment | "production"
      meta table_name = match @env {
        "dev" => "dev_orders",
        "staging" => "staging_orders",
        "production" => "prod_orders",
        _ => "dev_orders"
      }

      # Adjust query complexity based on urgency
      meta columns = if this.detailed.bool().catch(false) {
        ["order_id", "customer_id", "total", "items", "shipping_address"]
      } else {
        ["order_id", "customer_id", "total"]
      }
----

=== Error handling and fallbacks

Implement error handling to make your tools reliable:

[source,yaml]
----
processors:
  - label: primary_fetch
    try:
      - http:
          url: "https://api.primary.com/data"
          timeout: "10s"
    catch:
      - log:
          message: "Primary API failed, trying fallback"
      - label: fallback_fetch
        http:
          url: "https://api.fallback.com/data"
          timeout: "15s"
      - mutation: |
          root.metadata.source = "fallback"
          root.metadata.warning = "Primary source unavailable"
----

=== Conditional processing

Build tools that branch based on input or data characteristics:

[source,yaml]
----
processors:
  - label: conditional_processing
    switch:
      - check: this.data_type == "json"
        processors:
          - json:
              operator: "parse"
          - mutation: 'root.parsed_data = this'
      - check: this.data_type == "csv"
        processors:
          - csv:
              parse: true
          - mutation: 'root.parsed_data = this'
      - processors:
          - mutation: 'root.error = "Unsupported data type"'
----
