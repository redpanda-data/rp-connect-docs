// This content is autogenerated. Do not edit manually.

== Examples

=== Table Insert (MySQL)

The following example inserts rows into the table footable with the columns foo, bar and baz populated with values extracted from messages.

[source,yaml]
----
pipeline:
  processors:
    - sql_raw:
        driver: mysql
        dsn: foouser:foopassword@tcp(localhost:3306)/foodb
        query: "INSERT INTO footable (foo, bar, baz) VALUES (?, ?, ?);"
        args_mapping: '[ document.foo, document.bar, meta("kafka_topic") ]'
        exec_only: true
----

=== Table Query (PostgreSQL)

Here we query a database for columns of footable that share a `user_id` with the message field `user.id`. A xref:components:processors/branch.adoc[`branch` processor] is used in order to insert the resulting array into the original message at the path `foo_rows`.

[source,yaml]
----
pipeline:
  processors:
    - branch:
        processors:
          - sql_raw:
              driver: postgres
              dsn: postgres://foouser:foopass@localhost:5432/testdb?sslmode=disable
              query: "SELECT * FROM footable WHERE user_id = $1;"
              args_mapping: '[ this.user.id ]'
        result_map: 'root.foo_rows = this'
----

=== Dynamically Creating Tables (PostgreSQL)

Here we query a database for columns of footable that share a `user_id` with the message field `user.id`. A xref:components:processors/branch.adoc[`branch` processor] is used in order to insert the resulting array into the original message at the path `foo_rows`.

[source,yaml]
----
pipeline:
  processors:
    - mapping: |
        root = this
        # Prevent SQL injection when using unsafe_dynamic_query
        meta table_name = "\"" + metadata("table_name").replace_all("\"", "\"\"") + "\""
    - sql_raw:
        driver: postgres
        dsn: postgres://localhost/postgres
        unsafe_dynamic_query: true
        queries:
          - query: |
              CREATE TABLE IF NOT EXISTS ${!metadata("table_name")} (id varchar primary key, document jsonb);
          - query: |
              INSERT INTO ${!metadata("table_name")} (id, document) VALUES ($1, $2)
              ON CONFLICT (id) DO UPDATE SET document = EXCLUDED.document;
            args_mapping: |
              root = [ this.id, this.document.string() ]
----


